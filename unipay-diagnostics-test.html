<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UniPay Diagnostics Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 14px;
        }
        .button:hover {
            background: #0056b3;
        }
        .button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .results {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 500px;
            overflow-y: auto;
        }
        .success { border-left: 4px solid #28a745; background: #d4edda; }
        .error { border-left: 4px solid #dc3545; background: #f8d7da; }
        .warning { border-left: 4px solid #ffc107; background: #fff3cd; }
        .info { border-left: 4px solid #17a2b8; background: #d1ecf1; }
        .status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin: 2px;
        }
        .status.good { background: #28a745; color: white; }
        .status.issues { background: #dc3545; color: white; }
        .status.unknown { background: #6c757d; color: white; }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            vertical-align: middle;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <h1>UniPay Integration Diagnostics</h1>
    
    <div class="container">
        <h2>Diagnostic Tests</h2>
        <p>These tests will help diagnose the UniPay API integration issues with environment variables on Vercel.</p>
        
        <button class="button" onclick="runBasicDiagnostics()" id="basicBtn">
            Run Basic Diagnostics (GET)
        </button>
        
        <button class="button" onclick="runEnhancedDiagnostics()" id="enhancedBtn">
            Run Enhanced Diagnostics (POST)
        </button>
        
        <button class="button" onclick="testCurrentEndpoint()" id="currentBtn">
            Test Current Payment Endpoint
        </button>
        
        <button class="button" onclick="clearResults()">Clear Results</button>
    </div>

    <div id="results"></div>

    <script>
        const API_BASE = window.location.origin;

        function showLoading(buttonId, text = 'Testing...') {
            const button = document.getElementById(buttonId);
            button.innerHTML = `<span class="loading"></span>${text}`;
            button.disabled = true;
        }

        function hideLoading(buttonId, originalText) {
            const button = document.getElementById(buttonId);
            button.innerHTML = originalText;
            button.disabled = false;
        }

        function addResult(title, data, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `container results ${type}`;
            
            let formattedData;
            if (typeof data === 'object') {
                formattedData = JSON.stringify(data, null, 2);
            } else {
                formattedData = data;
            }
            
            resultDiv.innerHTML = `
                <h3>${title}</h3>
                <div>${formattedData}</div>
            `;
            resultsDiv.appendChild(resultDiv);
            
            // Scroll to bottom
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function getStatusClass(status) {
            if (status === 'GOOD' || status === 'SUCCESS' || status === 'YES') return 'good';
            if (status === 'ISSUES' || status === 'NO' || status.includes('FAILED')) return 'issues';
            return 'unknown';
        }

        function formatDiagnosticsResult(data) {
            let summary = `
üîç DIAGNOSTIC SUMMARY
Timestamp: ${data.timestamp}
Vercel Region: ${data.vercel_region}
Node Version: ${data.node_version}

üìä CONFIGURATION STATUS:
`;
            
            if (data.merchant_id_analysis) {
                summary += `
Merchant ID:
  ‚úì Configured: ${data.merchant_id_analysis.configured}
  ‚úì Matches Expected: ${data.merchant_id_analysis.matches_expected}
  ‚úì Value: ${data.merchant_id_analysis.actual_value}
  ‚úì Length: ${data.merchant_id_analysis.length}
`;
            }

            if (data.api_key_analysis) {
                summary += `
API Key:
  ‚úì Configured: ${data.api_key_analysis.configured}
  ‚úì Matches Expected: ${data.api_key_analysis.matches_expected}
  ‚úì Length: ${data.api_key_analysis.length}/36 (Expected: 36)
  ‚úì Has Dashes: ${data.api_key_analysis.has_dashes} (Count: ${data.api_key_analysis.dash_count}/4)
  ‚úì UUID Format: ${data.api_key_analysis.is_uuid_format}
  ‚úì Has Whitespace: ${data.api_key_analysis.has_whitespace}
  ‚úì Has Quotes: ${data.api_key_analysis.starts_ends_with_quotes}
  ‚úì Masked Value: ${data.api_key_analysis.masked_value}
`;
            }

            if (data.connectivity_test) {
                summary += `
üåê CONNECTIVITY TEST:
  Status: ${data.connectivity_test.status}
  Details: ${data.connectivity_test.details}
`;
            }

            if (data.auth_test) {
                summary += `
üîê AUTHENTICATION TEST:
  Status: ${data.auth_test.status}
  Details: ${data.auth_test.details}
`;
            }

            if (data.expected_credentials_test) {
                summary += `
üß™ EXPECTED CREDENTIALS TEST:
  Status: ${data.expected_credentials_test.status}
  Details: ${data.expected_credentials_test.details}
  Issue Identified: ${data.expected_credentials_test.comparison_with_env?.issue_identified || 'Unknown'}
`;
            }

            if (data.overall_status) {
                summary += `
üéØ OVERALL STATUS:
  Configuration: ${data.overall_status.configuration}
  Connectivity: ${data.overall_status.connectivity}
  Authentication: ${data.overall_status.authentication}
  Ready for Production: ${data.overall_status.ready_for_production}
`;
            }

            return summary;
        }

        async function runBasicDiagnostics() {
            showLoading('basicBtn');
            
            try {
                const response = await fetch(`${API_BASE}/api/unipay-env-diagnostics`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    addResult('‚úÖ Basic Diagnostics Results', formatDiagnosticsResult(data), 'success');
                } else {
                    addResult('‚ùå Basic Diagnostics Failed', data, 'error');
                }

            } catch (error) {
                addResult('‚ùå Basic Diagnostics Error', {
                    error: 'Network or parsing error',
                    message: error.message,
                    details: 'Check if the diagnostic endpoint is deployed correctly'
                }, 'error');
            } finally {
                hideLoading('basicBtn', 'Run Basic Diagnostics (GET)');
            }
        }

        async function runEnhancedDiagnostics() {
            showLoading('enhancedBtn');
            
            try {
                const response = await fetch(`${API_BASE}/api/unipay-env-diagnostics`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    addResult('‚úÖ Enhanced Diagnostics Results', formatDiagnosticsResult(data), 'success');
                } else {
                    addResult('‚ùå Enhanced Diagnostics Failed', data, 'error');
                }

            } catch (error) {
                addResult('‚ùå Enhanced Diagnostics Error', {
                    error: 'Network or parsing error',
                    message: error.message,
                    details: 'Check if the diagnostic endpoint is deployed correctly'
                }, 'error');
            } finally {
                hideLoading('enhancedBtn', 'Run Enhanced Diagnostics (POST)');
            }
        }

        async function testCurrentEndpoint() {
            showLoading('currentBtn');
            
            try {
                // Test the current payment creation endpoint with sample data
                const testPayload = {
                    amount: 10,
                    userDetails: {
                        name: "Test User",
                        email: "test@example.com",
                        phone: "595123456"
                    },
                    ticketInfo: {
                        name: "Test Ticket"
                    }
                };

                const response = await fetch(`${API_BASE}/api/unipay-create-order-production`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testPayload)
                });

                const data = await response.json();
                
                if (response.ok) {
                    addResult('‚úÖ Payment Endpoint Test Results', {
                        status: 'SUCCESS',
                        response_data: data,
                        note: 'Payment endpoint is working correctly!'
                    }, 'success');
                } else {
                    addResult('‚ùå Payment Endpoint Test Failed', {
                        status: response.status,
                        response_data: data,
                        note: 'This is the actual error from your payment endpoint'
                    }, 'error');
                }

            } catch (error) {
                addResult('‚ùå Payment Endpoint Test Error', {
                    error: 'Network or parsing error',
                    message: error.message
                }, 'error');
            } finally {
                hideLoading('currentBtn', 'Test Current Payment Endpoint');
            }
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        // Show instructions on load
        window.onload = function() {
            addResult('üìã Instructions', `
Welcome to the UniPay Diagnostics Tool!

Follow these steps to diagnose your UniPay integration:

1. üîç Run Basic Diagnostics (GET)
   - Tests environment variable configuration
   - Checks API connectivity
   - Tests authentication with current settings

2. üß™ Run Enhanced Diagnostics (POST)  
   - Everything from basic diagnostics
   - Tests expected credentials for comparison
   - Provides detailed character analysis

3. ‚ö° Test Current Payment Endpoint
   - Tests your actual payment creation endpoint
   - Uses sample data to simulate real payment
   - Shows the exact error you're experiencing

Start with Basic Diagnostics to get an overview, then run Enhanced Diagnostics for detailed analysis.
`, 'info');
        };
    </script>
</body>
</html>