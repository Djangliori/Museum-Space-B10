export class BookingPage {
    constructor(analytics, paymentManager, apiClient) {
        this.analytics = analytics;
        this.paymentManager = paymentManager;
        this.apiClient = apiClient;
        this.form = document.getElementById('bookingForm');
        this.cardPaymentBtn = document.getElementById('cardPayment');
        this.bankTransferBtn = document.getElementById('bankTransfer');
        this.successMessage = document.getElementById('successMessage');
        if (this.form) {
            this.init();
        }
    }
    init() {
        this.loadSelectedTicket();
        this.initEventListeners();
        this.updatePaymentButtons();
        this.trackPageView();
    }
    loadSelectedTicket() {
        const selectedTicket = this.paymentManager.getSelectedTicket();
        if (selectedTicket) {
            try {
                // Update page subtitle with ticket info
                const subtitleElement = document.querySelector('.booking-subtitle');
                if (subtitleElement) {
                    subtitleElement.textContent = `рЃерЃћрЃарЃЕрЃћрЃБрЃџрЃў: ${selectedTicket.name} - ${selectedTicket.price}РѓЙ`;
                }
                // Auto-fill ticket type field if it exists
                const ticketTypeField = document.getElementById('ticketType');
                if (ticketTypeField) {
                    ticketTypeField.value = selectedTicket.name;
                }
            }
            catch (error) {
                console.error('Error loading selected ticket:', error);
                this.analytics.trackError('Failed to load selected ticket', 'booking_page');
            }
        }
    }
    initEventListeners() {
        // Real-time validation for required inputs
        const inputs = this.form.querySelectorAll('input[required]');
        inputs.forEach(input => {
            input.addEventListener('input', () => {
                this.validateField(input);
                this.updatePaymentButtons();
            });
            input.addEventListener('blur', () => {
                this.validateField(input);
            });
        });
        // Payment method handlers
        this.cardPaymentBtn.addEventListener('click', () => this.handleCardPayment());
        this.bankTransferBtn.addEventListener('click', () => this.handleBankTransfer());
    }
    validateField(field) {
        const errorElement = document.getElementById(field.id + 'Error');
        let result;
        switch (field.id) {
            case 'firstName':
            case 'lastName':
                result = this.validateName(field.value);
                break;
            case 'phone':
                result = this.validatePhone(field.value);
                break;
            default:
                result = { isValid: field.value.trim().length > 0 };
        }
        // Update UI based on validation result
        this.updateFieldUI(field, result, errorElement);
        return result;
    }
    validateName(value) {
        const trimmed = value.trim();
        if (trimmed.length < 2) {
            return {
                isValid: false,
                errorMessage: 'рЃАрЃљрЃ«рЃћрЃџрЃў рЃБрЃюрЃЊрЃљ рЃўрЃДрЃЮрЃА рЃЏрЃўрЃюрЃўрЃЏрЃБрЃЏ 2 рЃАрЃўрЃЏрЃЉрЃЮрЃџрЃЮ'
            };
        }
        return { isValid: true };
    }
    validatePhone(value) {
        const phoneRegex = /^(\+995|995)?[0-9]{9}$/;
        const cleanPhone = value.replace(/\s/g, '');
        if (!phoneRegex.test(cleanPhone)) {
            return {
                isValid: false,
                errorMessage: 'рЃерЃћрЃљрЃЋрЃАрЃћрЃЌ рЃЋрЃљрЃџрЃўрЃЊрЃБрЃарЃў рЃбрЃћрЃџрЃћрЃцрЃЮрЃюрЃўрЃА рЃюрЃЮрЃЏрЃћрЃарЃў'
            };
        }
        return { isValid: true };
    }
    updateFieldUI(field, result, errorElement) {
        if (result.isValid) {
            field.style.borderColor = '#28a745';
            errorElement.style.display = 'none';
        }
        else {
            field.style.borderColor = '#e74c3c';
            if (result.errorMessage) {
                errorElement.textContent = result.errorMessage;
            }
            errorElement.style.display = 'block';
        }
    }
    isFormValid() {
        const inputs = this.form.querySelectorAll('input[required]');
        return Array.from(inputs).every(input => this.validateField(input).isValid);
    }
    updatePaymentButtons() {
        const isValid = this.isFormValid();
        this.cardPaymentBtn.disabled = !isValid;
        this.bankTransferBtn.disabled = !isValid;
    }
    getFormData() {
        return {
            firstName: document.getElementById('firstName').value.trim(),
            lastName: document.getElementById('lastName').value.trim(),
            phone: document.getElementById('phone').value.trim(),
            orderId: this.paymentManager.generateOrderId(),
            timestamp: new Date().toLocaleString('ka-GE')
        };
    }
    async handleCardPayment() {
        if (!this.isFormValid())
            return;
        const data = this.getFormData();
        // Show loading state
        this.cardPaymentBtn.disabled = true;
        this.cardPaymentBtn.textContent = 'РЈ│ рЃњрЃљрЃЊрЃљрЃ«рЃЊрЃљ рЃЏрЃБрЃерЃљрЃЋрЃЊрЃћрЃЉрЃљ...';
        try {
            // Process payment through PaymentManager
            const result = await this.paymentManager.processCardPayment(data, 10.0, 'рЃАрЃљрЃЏрЃБрЃќрЃћрЃБрЃЏрЃЮ рЃАрЃўрЃЋрЃарЃфрЃўрЃА рЃЉрЃўрЃџрЃћрЃЌрЃў');
            if (result.success && result.paymentUrl) {
                // Show success message briefly
                this.updateStepIndicator(2);
                this.successMessage.textContent = 'РюЁ рЃерЃћрЃЎрЃЋрЃћрЃЌрЃљ рЃерЃћрЃЦрЃЏрЃюрЃўрЃџрЃўрЃљ! рЃњрЃљрЃЊрЃљрЃЏрЃўрЃАрЃљрЃЏрЃљрЃарЃЌрЃћрЃЉрЃљ рЃБрЃюрЃўрЃцрЃћрЃўрЃА рЃњрЃЋрЃћрЃарЃЊрЃќрЃћ...';
                this.successMessage.style.display = 'block';
                this.form.style.display = 'none';
                // Redirect to UniPay
                this.paymentManager.redirectToPayment(result.paymentUrl, 2000);
            }
            else {
                throw new Error(result.details || 'Payment initialization failed');
            }
        }
        catch (error) {
            console.error('Payment error:', error);
            // Show error message
            const errorMessage = error instanceof Error ? error.message : 'Unknown error';
            this.successMessage.textContent = `РЮї рЃерЃћрЃфрЃЊрЃЮрЃЏрЃљ! ${errorMessage}. рЃњрЃЌрЃ«рЃЮрЃЋрЃЌ рЃЎрЃЋрЃџрЃљрЃЋ рЃАрЃфрЃљрЃЊрЃЮрЃЌ рЃљрЃю рЃЊрЃљрЃБрЃЎрЃљрЃЋрЃерЃўрЃарЃЊрЃўрЃЌ рЃЏрЃ«рЃљрЃарЃЊрЃљрЃГрЃћрЃарЃљрЃА`;
            this.successMessage.style.display = 'block';
            // Reset button
            this.cardPaymentBtn.disabled = false;
            this.cardPaymentBtn.textContent = '­Ъњ│ рЃЉрЃљрЃарЃљрЃЌрЃўрЃЌ рЃњрЃљрЃЊрЃљрЃ«рЃЊрЃљ';
            // Track error
            this.analytics.trackError(errorMessage, 'booking_payment');
        }
    }
    handleBankTransfer() {
        if (!this.isFormValid())
            return;
        const data = this.getFormData();
        this.proceedToNextStep('bank', data);
        // Track bank transfer selection
        this.analytics.trackFormInteraction('booking', 'bank_transfer_selected');
    }
    proceedToNextStep(paymentMethod, data) {
        // Update step indicator
        this.updateStepIndicator(2);
        // Show success message with next step info
        let message = '';
        if (paymentMethod === 'card') {
            message = `РюЁ рЃерЃћрЃЎрЃЋрЃћрЃЌрЃљ рЃарЃћрЃњрЃўрЃАрЃбрЃарЃўрЃарЃћрЃЉрЃБрЃџрЃўрЃљ!\n­Ъєћ рЃерЃћрЃЎрЃЋрЃћрЃЌрЃўрЃА рЃЎрЃЮрЃЊрЃў: ${data.orderId}\n­ЪЉц ${data.firstName} ${data.lastName}\n­ЪЊъ ${data.phone}\n\nрЃерЃћрЃЏрЃЊрЃћрЃњрЃў рЃюрЃљрЃЉрЃўрЃ»рЃў: рЃЉрЃљрЃарЃљрЃЌрЃўрЃЌ рЃњрЃљрЃЊрЃљрЃ«рЃЊрЃљ\nрЃњрЃЌрЃ«рЃЮрЃЋрЃЌ рЃЊрЃљрЃћрЃџрЃЮрЃЊрЃЮрЃЌ, рЃЏрЃљрЃџрЃћ рЃњрЃљрЃЊрЃљрЃњрЃўрЃДрЃЋрЃљрЃюрЃЌ рЃњрЃљрЃЊрЃљрЃ«рЃЊрЃўрЃА рЃњрЃЋрЃћрЃарЃЊрЃќрЃћ...`;
        }
        else {
            message = `РюЁ рЃерЃћрЃЎрЃЋрЃћрЃЌрЃљ рЃарЃћрЃњрЃўрЃАрЃбрЃарЃўрЃарЃћрЃЉрЃБрЃџрЃўрЃљ!\n­Ъєћ рЃерЃћрЃЎрЃЋрЃћрЃЌрЃўрЃА рЃЎрЃЮрЃЊрЃў: ${data.orderId}\n­ЪЉц ${data.firstName} ${data.lastName}\n­ЪЊъ ${data.phone}\n\nрЃерЃћрЃЏрЃЊрЃћрЃњрЃў рЃюрЃљрЃЉрЃўрЃ»рЃў: рЃЉрЃљрЃюрЃЎрЃерЃў рЃњрЃљрЃЊрЃљрЃарЃўрЃфрЃ«рЃЋрЃљ\nрЃЏрЃљрЃџрЃћ рЃЏрЃўрЃўрЃдрЃћрЃЉрЃЌ рЃўрЃюрЃАрЃбрЃарЃБрЃЦрЃфрЃўрЃћрЃЉрЃА...`;
        }
        this.successMessage.textContent = message;
        this.successMessage.style.display = 'block';
        this.form.style.display = 'none';
        // Simulate next step after 3 seconds for bank transfer
        if (paymentMethod === 'bank') {
            setTimeout(() => {
                this.simulateNextStep(paymentMethod, data);
            }, 3000);
        }
    }
    updateStepIndicator(activeStep) {
        const steps = document.querySelectorAll('.step');
        steps.forEach((step, index) => {
            if (index + 1 <= activeStep) {
                step.classList.remove('inactive');
                step.classList.add('active');
            }
        });
    }
    simulateNextStep(paymentMethod, data) {
        this.updateStepIndicator(3);
        if (paymentMethod === 'bank') {
            this.successMessage.innerHTML = `
        <strong>­ЪЈд рЃЉрЃљрЃюрЃЎрЃерЃў рЃњрЃљрЃЊрЃљрЃарЃўрЃфрЃ«рЃЋрЃўрЃА рЃўрЃюрЃАрЃбрЃарЃБрЃЦрЃфрЃўрЃљ</strong><br>
        ­Ъєћ рЃерЃћрЃЎрЃЋрЃћрЃЌрЃўрЃА рЃЎрЃЮрЃЊрЃў: <strong>${data.orderId}</strong><br><br>
        <strong>рЃЉрЃљрЃюрЃЎрЃўрЃА рЃарЃћрЃЎрЃЋрЃўрЃќрЃўрЃбрЃћрЃЉрЃў:</strong><br>
        рЃЏрЃўрЃЏрЃдрЃћрЃЉрЃў: рЃерЃърЃА рЃАрЃљрЃЏрЃБрЃќрЃћрЃБрЃЏрЃЮ рЃАрЃўрЃЋрЃарЃфрЃћ<br>
        рЃљрЃюрЃњрЃљрЃарЃўрЃерЃўрЃА рЃюрЃЮрЃЏрЃћрЃарЃў: GE00TB0000000000000000<br>
        рЃЉрЃљрЃюрЃЎрЃў: рЃЌрЃўрЃЉрЃўрЃАрЃў рЃЉрЃљрЃюрЃЎрЃў<br>
        рЃЊрЃљрЃюрЃўрЃерЃюрЃБрЃџрЃћрЃЉрЃљ: ${data.orderId}<br><br>
        <strong>рЃАрЃљрЃЎрЃЮрЃюрЃбрЃљрЃЦрЃбрЃЮ рЃўрЃюрЃцрЃЮрЃарЃЏрЃљрЃфрЃўрЃљ:</strong><br>
        ­ЪЊД betlemi.museum@gmail.com<br>
        ­ЪЊъ +995 32 2 123 456
      `;
        }
    }
    trackPageView() {
        this.analytics.trackPageView('Booking - рЃЉрЃўрЃџрЃћрЃЌрЃћрЃЉрЃўрЃА рЃерЃћрЃЎрЃЋрЃћрЃЌрЃљ');
    }
    // Public method for external form reset
    resetForm() {
        this.form.reset();
        this.updatePaymentButtons();
        this.successMessage.style.display = 'none';
        this.form.style.display = 'block';
        this.updateStepIndicator(1);
    }
    // Destroy method for cleanup
    destroy() {
        // Clean up event listeners if needed
        this.paymentManager.clearSelectedTicket();
    }
}
//# sourceMappingURL=booking.js.map